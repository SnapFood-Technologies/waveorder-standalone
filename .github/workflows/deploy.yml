name: ğŸš€ Deploy to Azure Production Server

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Allows manual triggering
  schedule:
    # Run low stock alerts daily at 8 AM UTC
    - cron: '0 8 * * *'

# Configuration variables - change these as needed
env:
  NODE_VERSION: '22'
  APP_NAME: 'waveorder-web-app'  # Change this to your preferred app name
  PM2_ECOSYSTEM_FILE: 'ecosystem.config.js'  # Optional: if you want to use PM2 ecosystem file

jobs:
  deploy:
    name: ğŸ—ï¸ Build and Deploy
    runs-on: self-hosted
    timeout-minutes: 15  # Prevents hanging builds
    
    steps:
      # ğŸ“¥ CHECKOUT CODE
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          clean: true  # Ensures clean checkout

      # ğŸ§¹ CLEAN PREVIOUS BUILD
      - name: ğŸ§¹ Clean Previous Build
        run: |
          echo "Cleaning previous build artifacts..."
          rm -rf node_modules
          rm -rf .next
          rm -f package-lock.json
          echo "âœ… Cleanup completed"

      # âš™ï¸ SETUP NODE.JS
      - name: âš™ï¸ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # ğŸ“¦ INSTALL YARN
      - name: ğŸ“¦ Install Yarn
        run: |
          echo "Installing Yarn..."
          npm install -g yarn
          yarn --version
          echo "âœ… Yarn installed successfully"

      # ğŸ“¦ INSTALL DEPENDENCIES
      - name: ğŸ“¦ Install Dependencies
        run: |
          echo "Installing dependencies with Yarn..."
          yarn install --frozen-lockfile
          echo "âœ… Dependencies installed successfully"

      # ğŸ—ï¸ BUILD APPLICATION
      - name: ğŸ—ï¸ Build Application
        env:
          # ğŸ—„ï¸ Database
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          
          # ğŸ” Authentication
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          
          # ğŸ’³ Stripe Payment Processing
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
          STRIPE_FREE_PRICE_ID: ${{ secrets.STRIPE_FREE_PRICE_ID }}
          STRIPE_PRO_PRICE_ID: ${{ secrets.STRIPE_PRO_PRICE_ID }}
          STRIPE_PRO_ANNUAL_PRICE_ID: ${{ secrets.STRIPE_PRO_ANNUAL_PRICE_ID }}
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY }}
          
          # ğŸ”§ API Keys
          AKISMET_API_KEY: ${{ secrets.AKISMET_API_KEY }}
          BKT_API_KEY: ${{ secrets.BKT_API_KEY }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          PAYPAL_CLIENT_ID: ${{ secrets.PAYPAL_CLIENT_ID }}

          # CRON
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
          
          # ğŸŒ Public Environment Variables
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          NEXT_PUBLIC_CLARITY_ID: ${{ secrets.NEXT_PUBLIC_CLARITY_ID }}
          NEXT_PUBLIC_GA_ID: ${{ secrets.NEXT_PUBLIC_GA_ID }}
          NEXT_PUBLIC_GOOGLE_MAPS_API_KEY: ${{ secrets.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY }}
          
          # ğŸ“§ Email Configuration
          CONTACT_EMAIL: ${{ secrets.CONTACT_EMAIL }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          LEGAL_EMAIL: ${{ secrets.LEGAL_EMAIL }}
          PRIVACY_EMAIL: ${{ secrets.PRIVACY_EMAIL }}

          # API Docs
          API_DOCS_PASSWORD: ${{ secrets.API_DOCS_PASSWORD }}
          
          # ğŸ­ Build Environment
          NODE_ENV: production
        run: |
          echo "Starting build process..."
          yarn build
          echo "âœ… Build completed successfully"

      # ğŸ“¦ UPDATE PRODUCTS FROM CSV
      - name: ğŸ“¦ Update Products from CSV
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "Checking for products CSV file..."
          CSV_FILE="products-export-2026-01-094.csv"
          BUSINESS_ID="${{ secrets.PRODUCTS_BUSINESS_ID }}"
          
          if [ -f "$CSV_FILE" ] && [ -n "$BUSINESS_ID" ]; then
            echo "ğŸ“¦ Running product update script..."
            echo "CSV File: $CSV_FILE"
            echo "Business ID: $BUSINESS_ID"
            npx tsx scripts/update-products.ts "$CSV_FILE" "$BUSINESS_ID"
            echo "âœ… Product update completed"
          else
            if [ ! -f "$CSV_FILE" ]; then
              echo "âš ï¸ CSV file not found: $CSV_FILE (skipping product update)"
            fi
            if [ -z "$BUSINESS_ID" ]; then
              echo "âš ï¸ PRODUCTS_BUSINESS_ID secret not set (skipping product update)"
            fi
          fi

      # ğŸ§¹ CLEANUP DEPENDENCIES
      - name: ğŸ§¹ Remove Development Dependencies
        run: |
          echo "Removing development dependencies..."
          yarn install --production --frozen-lockfile
          echo "âœ… Development dependencies removed"

      # ğŸ“ CREATE PRODUCTION ENVIRONMENT FILE
      - name: ğŸ“ Create Production Environment
        run: |
          echo "Creating production environment file..."
          cat > .env.production <<'EOF'
          # ğŸ­ Production Environment Configuration
          NODE_ENV=production
          
          # ğŸ—„ï¸ Database
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          
          # ğŸ” Authentication
          NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
          GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
          
          # ğŸ’³ Stripe Payment Processing
          STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET }}
          STRIPE_FREE_PRICE_ID=${{ secrets.STRIPE_FREE_PRICE_ID }}
          STRIPE_PRO_PRICE_ID=${{ secrets.STRIPE_PRO_PRICE_ID }}
          STRIPE_PRO_ANNUAL_PRICE_ID=${{ secrets.STRIPE_PRO_ANNUAL_PRICE_ID }}
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${{ secrets.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY }}
          
          # ğŸ”§ API Keys
          AKISMET_API_KEY=${{ secrets.AKISMET_API_KEY }}
          BKT_API_KEY=${{ secrets.BKT_API_KEY }}
          RESEND_API_KEY=${{ secrets.RESEND_API_KEY }}
          PAYPAL_CLIENT_ID=${{ secrets.PAYPAL_CLIENT_ID }}

          # CRON
          CRON_SECRET=${{ secrets.CRON_SECRET }}
          
          # ğŸŒ Public Variables
          NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          NEXT_PUBLIC_CLARITY_ID=${{ secrets.NEXT_PUBLIC_CLARITY_ID }}
          NEXT_PUBLIC_GA_ID=${{ secrets.NEXT_PUBLIC_GA_ID }}
          NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=${{ secrets.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY }}

          # ğŸ“§ Email Configuration
          CONTACT_EMAIL=${{ secrets.CONTACT_EMAIL }}
          EMAIL_FROM=${{ secrets.EMAIL_FROM }}
          LEGAL_EMAIL=${{ secrets.LEGAL_EMAIL }}
          PRIVACY_EMAIL=${{ secrets.PRIVACY_EMAIL }}

          # API Docs
          API_DOCS_PASSWORD=${{ secrets.API_DOCS_PASSWORD }}
          EOF
          echo "âœ… Production environment file created"

      # ğŸ“¦ SETUP PM2
      - name: ğŸ“¦ Setup PM2 Process Manager
        run: |
          echo "Checking PM2 installation..."
          if ! command -v pm2 &> /dev/null; then
            echo "Installing PM2 globally..."
            yarn global add pm2
          else
            echo "PM2 is already installed"
          fi
          pm2 --version

      # ğŸš€ DEPLOY APPLICATION
      - name: ğŸš€ Deploy Application
        run: |
          echo "Deploying application: ${{ env.APP_NAME }}"
          
          # Check if app is already running
          if pm2 list | grep -q "${{ env.APP_NAME }}"; then
            echo "â™»ï¸ Reloading existing application..."
            pm2 reload ${{ env.APP_NAME }} --wait-ready --listen-timeout 10000 || {
              echo "âš ï¸ Reload failed, attempting restart..."
              pm2 restart ${{ env.APP_NAME }}
            }
          else
            echo "ğŸ†• Starting new application..."
            pm2 start yarn --name "${{ env.APP_NAME }}" -- start
          fi
          
          # Save PM2 process list
          pm2 save
          
          echo "âœ… Application deployed successfully!"

      # âœ… DEPLOYMENT STATUS
      - name: âœ… Verify Deployment
        run: |
          echo "ğŸ” Checking application status..."
          pm2 status
          pm2 logs ${{ env.APP_NAME }} --lines 5 --nostream
          echo "âœ… Deployment verification complete!"

      # ğŸ“§ LOW STOCK ALERTS (Only runs on schedule)
      - name: ğŸ“§ Send Low Stock Alerts
        if: github.event_name == 'schedule'
        run: |
          echo "ğŸ“§ Triggering low stock alerts..."
          curl -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
               -H "Content-Type: application/json" \
               https://your-domain.com/api/cron/low-stock-alerts
          echo "âœ… Low stock alerts sent successfully"