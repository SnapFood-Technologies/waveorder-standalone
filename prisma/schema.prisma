generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(auto()) @map("_id") @db.ObjectId
  userId            String  @db.ObjectId
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.String
  access_token      String? @db.String
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.String
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  sessionToken String   @unique
  userId       String   @db.ObjectId
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?

  // Email change verification
  pendingEmail      String?
  emailChangeToken  String?
  emailChangeExpiry DateTime?

  verificationToken  String?
  verificationExpiry DateTime?

  // Login activity tracking
  loginActivity LoginActivity[]

  lastPasswordChange DateTime?

  setupToken  String?
  setupExpiry DateTime?

  passwordSetupToken  String?
  passwordSetupExpiry DateTime?

  // Subscription and Stripe fields
  plan             SubscriptionPlan @default(STARTER)
  stripeCustomerId String?
  subscriptionId   String?          @db.ObjectId
  subscription     Subscription?    @relation(fields: [subscriptionId], references: [id])

  // Trial tracking
  trialEndsAt DateTime? // When 14-day trial expires
  graceEndsAt DateTime? // When 7-day grace period expires (after trial)
  trialUsed   Boolean   @default(false) // Prevent re-using trial

  // Multi-store preference
  defaultBusinessId String? @db.ObjectId

  role       UserRole       @default(BUSINESS_OWNER)
  accounts   Account[]
  sessions   Session[]
  businesses BusinessUser[]

  // Support relations
  createdTickets  SupportTicket[] @relation("TicketCreator")
  assignedTickets SupportTicket[] @relation("TicketAssignee")
  resolvedTickets SupportTicket[] @relation("TicketResolver")
  ticketComments  TicketComment[]

  sentMessages     SupportMessage[] @relation("MessageSender")
  receivedMessages SupportMessage[] @relation("MessageRecipient")

  notifications Notification[]

  // SuperAdmin settings
  superAdminSettings SuperAdminSettings?

  // Lead assignments (for SuperAdmin team) - Legacy, use TeamMember instead
  assignedLeads Lead[] @relation("LeadAssignee")

  // Team Member profile (optional - links user account to team member)
  // One-to-many to avoid unique constraint issues with null userId
  teamMembers TeamMember[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LoginActivity {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  userId    String  @db.ObjectId
  device    String
  browser   String
  location  String
  ipAddress String
  userAgent String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  loginAt DateTime @default(now())

  @@index([userId])
  @@index([loginAt])
}

model VerificationToken {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verificationtokens")
}

// NEW: Subscription model for Stripe integration
model Subscription {
  id       String @id @default(auto()) @map("_id") @db.ObjectId
  stripeId String @unique

  status  String
  priceId String
  plan    SubscriptionPlan

  // Current period
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime

  // Cancellation
  cancelAtPeriodEnd Boolean   @default(false)
  canceledAt        DateTime?

  // Relations
  users User[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("subscriptions")
}

// NEW: Webhook logging model
model WebhookLog {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  eventType String
  stripeId  String?
  data      Json
  processed Boolean  @default(false)
  error     String?
  createdAt DateTime @default(now())

  @@map("webhook_logs")
}

// NEW: Email verification model
model EmailVerification {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  email     String
  token     String   @unique
  expires   DateTime
  type      String // 'verification', 'password_reset'
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@map("email_verifications")
}

model Business {
  id                          String             @id @default(auto()) @map("_id") @db.ObjectId
  name                        String
  slug                        String             @unique
  description                 String?
  logo                        String?
  coverImage                  String?
  phone                       String?
  email                       String?
  address                     String?
  country                     String? // ISO country code (e.g., "AL", "GR", "US")
  storeLatitude               Float?
  storeLongitude              Float?
  website                     String?
  whatsappNumber              String
  whatsappDirectNotifications Boolean            @default(false) // If true, send order notifications via Twilio instead of wa.me redirect
  businessType                BusinessType       @default(RESTAURANT)
  industry                    String? // Optional industry categorization (e.g., "Food & Beverage", "Hardware & Construction")
  subscriptionPlan            SubscriptionPlan   @default(STARTER)
  subscriptionStatus          SubscriptionStatus @default(ACTIVE)

  // Trial tracking (business-level)
  trialEndsAt DateTime?
  graceEndsAt DateTime?

  // Happy Hour / Daily Discounts
  happyHourEnabled         Boolean  @default(false) // SuperAdmin toggle to enable feature for this business
  happyHourActive          Boolean  @default(false) // Business toggle to activate happy hour
  happyHourStartTime       String? // Start time in HH:mm format (e.g., "20:00")
  happyHourEndTime         String? // End time in HH:mm format (e.g., "23:59")
  happyHourDiscountPercent Float? // Discount percentage (e.g., 20 for 20% off)
  happyHourProductIds      String[] // Product IDs that get the discount

  createdByAdmin Boolean @default(false)

  // Branding
  primaryColor        String  @default("#0D9488")
  secondaryColor      String  @default("#1F2937")
  fontFamily          String  @default("Inter")
  whatsappButtonColor String?
  mobileCartStyle     String  @default("bar")

  cartBadgeColor     String @default("#EF4444")
  featuredBadgeColor String @default("#EF4444")

  // Cover image CSS settings
  coverBackgroundSize     String? // 'cover', 'contain', '100% 100%', etc.
  coverBackgroundPosition String? // 'center', 'top', 'bottom', 'left', 'right', etc.
  coverHeight             String? // e.g., '200px', '250px', '300px', 'auto' (legacy / default)
  coverHeightMobile       String? // mobile-specific height
  coverHeightDesktop      String? // desktop-specific height

  // Logo CSS settings
  logoPadding   String? // e.g., '0px', '4px', '6px', '8px'
  logoObjectFit String? // 'cover' or 'contain', default 'cover'

  deliveryZones    DeliveryZone[]
  postals          Postal[]
  postalPricing    PostalPricing[]
  externalSyncs    ExternalSync[]
  externalSyncLogs ExternalSyncLog[]

  // Settings
  currency                           String  @default("USD")
  timezone                           String  @default("UTC")
  language                           String  @default("en")
  storefrontLanguage                 String  @default("en") // Language for storefront UI (defaults to business language, can be changed separately)
  timeFormat                         String  @default("24") // "12" for 12-hour format, "24" for 24-hour format
  translateContentToBusinessLanguage Boolean @default(true) // Translate customer-facing content to business language
  hideProductsWithoutPhotos          Boolean @default(false) // Hide products without photos from storefront

  // Uncategorized category name override (for storefront display only)
  uncategorizedNameOverride   String? // Override "Uncategorized" name in English for storefront
  uncategorizedNameOverrideAl String? // Override "Uncategorized" name in Albanian for storefront
  deliveryFee                 Float    @default(0)
  minimumOrder                Float    @default(0)
  freeDeliveryThreshold       Float? // Orders above this amount get free delivery (null = disabled)
  deliveryRadius              Float    @default(10)
  shippingCountries           String[] @default([]) // Array of country codes (e.g., ["AL", "XK", "MK"])

  // Payment settings
  paymentMethods      PaymentMethod[]
  paymentInstructions String?

  // Business hours
  businessHours Json?

  // Scheduling configuration
  schedulingEnabled     Boolean @default(true) // Enable/disable scheduling (false = instant orders only)
  slotDuration          Int     @default(30) // Time slot duration in minutes (15, 30, 60)
  slotCapacity          Int? // Max orders per time slot (null = unlimited)
  deliveryBufferMinutes Int     @default(45) // Buffer time for delivery orders
  pickupBufferMinutes   Int     @default(20) // Buffer time for pickup orders
  holidayHours          Json? // Special hours for specific dates: { "2026-12-25": { closed: true }, "2026-12-31": { open: "10:00", close: "15:00" } }
  maxAdvanceBookingDays Int     @default(7) // Maximum days in advance customers can schedule orders (4, 7, 14, 30, 60)

  // Inventory display settings
  showStockBadge Boolean @default(false) // Show stock status badge on storefront (In Stock/Low Stock/Out of Stock)

  // WhatsApp settings
  messageTemplate  String?
  autoReply        Boolean @default(false)
  autoReplyMessage String?

  customDomain             String?
  domainStatus             DomainStatus @default(NONE)
  domainVerificationToken  String? // TXT record verification token
  domainVerificationExpiry DateTime? // When verification expires
  domainProvisionedAt      DateTime? // When domain was successfully provisioned
  domainLastChecked        DateTime? // Last DNS/SSL check timestamp
  domainError              String? // Last error message if failed
  subdomainEnabled         Boolean      @default(false)

  businessGoals         BusinessGoal[]
  deliveryEnabled       Boolean        @default(true)
  pickupEnabled         Boolean        @default(false)
  dineInEnabled         Boolean        @default(false)
  estimatedDeliveryTime String?
  estimatedPickupTime   String?
  greetingMessage       String?
  orderNumberFormat     String         @default("WO-{number}")

  // Retail-specific custom texts
  deliveryTimeText String? // Custom delivery time text for RETAIL (overrides estimatedDeliveryTime)
  freeDeliveryText String? // Custom free delivery text for RETAIL (overrides default "Free Delivery")

  // Store Closure Fields
  isTemporarilyClosed Boolean   @default(false)
  closureReason       String?
  closureMessage      String?
  closureStartDate    DateTime?
  closureEndDate      DateTime?

  // External System Integration
  externalSystemName      String? // Name of the external system (e.g., "OmniStack", "Shopify", "WooCommerce")
  externalSystemBaseUrl   String? // Base URL for external product system API
  externalSystemApiKey    String? // API key for external system authentication
  externalSystemEndpoints Json? // Endpoint paths (e.g., { products: "/products", categories: "/categories" })
  externalBrandIds        Json? // External brand ID(s) - can be string or array of strings

  // SEO Configuration (English/Default)
  seoTitle       String?
  seoDescription String?
  seoKeywords    String?
  favicon        String?
  ogImage        String?
  canonicalUrl   String?
  noIndex        Boolean @default(false)
  noFollow       Boolean @default(false)

  // Structured Data / Schema.org
  schemaType String? @default("Person")
  schemaData Json?

  // Albanian SEO Configuration
  seoTitleAl       String?
  seoDescriptionAl String?
  seoKeywordsAl    String?
  descriptionAl    String?

  // Greek SEO Configuration
  seoTitleEl       String?
  seoDescriptionEl String?
  seoKeywordsEl    String?
  descriptionEl    String?

  isIndexable Boolean @default(false)

  // Order Notification Settings (to business)
  orderNotificationsEnabled    Boolean   @default(false)
  orderNotificationEmail       String?
  orderNotificationLastUpdate  DateTime?
  notifyOnAdminCreatedOrders   Boolean   @default(false)
  notifyAdminOnPickedUpAndPaid Boolean   @default(true)
  notifyAdminOnStatusUpdates   Boolean   @default(false) // Admin receives same status updates as customers

  // Customer Notification Settings (per status and order type)
  customerNotificationEnabled Boolean @default(false)

  // Global status toggles (apply to all order types)
  notifyCustomerOnConfirmed      Boolean @default(false)
  notifyCustomerOnPreparing      Boolean @default(false)
  notifyCustomerOnReady          Boolean @default(true)
  notifyCustomerOnOutForDelivery Boolean @default(true)
  notifyCustomerOnDelivered      Boolean @default(true)
  notifyCustomerOnCancelled      Boolean @default(true)

  // Delivery-specific settings
  notifyDeliveryOnConfirmed      Boolean @default(false)
  notifyDeliveryOnPreparing      Boolean @default(false)
  notifyDeliveryOnOutForDelivery Boolean @default(true)
  notifyDeliveryOnDelivered      Boolean @default(true)

  // Pickup-specific settings
  notifyPickupOnConfirmed Boolean @default(false)
  notifyPickupOnPreparing Boolean @default(false)
  notifyPickupOnReady     Boolean @default(true)
  notifyPickupOnDelivered Boolean @default(false)

  // Dine-in specific settings
  notifyDineInOnConfirmed Boolean @default(false)
  notifyDineInOnPreparing Boolean @default(false)
  notifyDineInOnReady     Boolean @default(true)
  notifyDineInOnDelivered Boolean @default(false)

  // Payment and pickup notifications
  notifyCustomerOnPaymentReceived Boolean @default(true)
  notifyCustomerOnPickedUpAndPaid Boolean @default(true)

  // Custom Features (managed by SuperAdmin)
  brandsFeatureEnabled      Boolean @default(false)
  collectionsFeatureEnabled Boolean @default(false)
  groupsFeatureEnabled      Boolean @default(false)
  customMenuEnabled         Boolean @default(false)
  customFilteringEnabled    Boolean @default(false)

  // Search Analytics (SuperAdmin enables, Business Admin views)
  showSearchAnalytics Boolean @default(false) // When enabled, business admin can see search analytics

  // Cost & Margins (SuperAdmin enables, Business Admin views)
  showCostPrice Boolean @default(false) // When enabled, business admin can see cost prices and margins

  // Production Planning / Prep List (SuperAdmin enables, Business Admin views)
  showProductionPlanning Boolean @default(false) // When enabled, business admin can see production queue

  // Custom Menu & Filtering Data (JSON)
  customMenuItems      Json? // Array of custom menu items
  customFilterSettings Json? // Filter configuration settings

  // Business Connections (marketplace/multi-business features)
  connectedBusinesses String[] @db.ObjectId

  // Account Manager Assignment
  accountManagerId String?     @db.ObjectId
  accountManager   TeamMember? @relation("AccountManagerBusinesses", fields: [accountManagerId], references: [id])

  users              BusinessUser[]
  categories         Category[]
  products           Product[]
  orders             Order[]
  customers          Customer[]
  analytics          Analytics[]
  visitorSessions    VisitorSession[]
  productEvents      ProductEvent[]
  orderNotifications OrderNotification[]
  anomalies          Anomaly[]
  brands             Brand[]
  collections        Collection[]
  groups             Group[]

  // Support relations
  supportTickets  SupportTicket[]
  supportMessages SupportMessage[]

  // System logs
  systemLogs SystemLog[]

  // Business Feedback
  feedbacks BusinessFeedback[]

  // Search Analytics
  searchLogs SearchLog[]

  // Supplier Payments (for Cost & Margins feature)
  supplierPayments SupplierPayment[]

  // API Keys (for Business Plan API Access)
  apiKeys ApiKey[]

  onboardingCompleted   Boolean   @default(false)
  onboardingStep        Int       @default(0)
  setupWizardCompleted  Boolean   @default(false)
  onboardingCompletedAt DateTime? // When onboarding was completed

  // Feedback tracking
  initialFeedbackCompletedAt DateTime? // When initial feedback was submitted (from any source)
  feedbackFormDismissedAt    DateTime? // When feedback form was dismissed (show again after 14 days)

  isActive           Boolean             @default(true)
  deactivatedAt      DateTime?
  deactivationReason String?
  testMode           Boolean             @default(false) // Test businesses excluded from analytics
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  TeamInvitation     TeamInvitation[]
  TeamAuditLog       TeamAuditLog[]
  InventoryActivity  InventoryActivity[]

  // Index for fast custom domain lookups in middleware
  @@index([customDomain, domainStatus, isActive])
}

model OrderNotification {
  id           String      @id @default(auto()) @map("_id") @db.ObjectId
  businessId   String      @db.ObjectId
  orderId      String      @db.ObjectId
  orderNumber  String
  orderStatus  OrderStatus
  customerName String
  total        Float
  notifiedAt   DateTime    @default(now())
  emailSent    Boolean     @default(false)
  emailError   String?

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  order    Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId])
  @@index([orderId])
}

// Search Analytics - Tracks storefront search queries
model SearchLog {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  businessId String   @db.ObjectId
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  searchTerm   String // The search query
  resultsCount Int // Number of products found

  // Optional tracking data
  sessionId String? // Visitor session ID for grouping searches
  ipAddress String? // Anonymized IP for analytics
  userAgent String? // Browser/device info

  createdAt DateTime @default(now())

  @@index([businessId])
  @@index([businessId, createdAt])
  @@index([searchTerm])
}

// Supplier Payment tracking for Cost & Margins feature
model SupplierPayment {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  businessId String   @db.ObjectId
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  supplierName String // Name of the supplier
  amount       Float // Amount paid
  currency     String @default("EUR") // Currency of payment

  periodStart DateTime? // Start of the period this payment covers
  periodEnd   DateTime? // End of the period this payment covers

  paymentMethod String? // e.g., "bank_transfer", "cash", "card"
  reference     String? // Payment reference/invoice number
  notes         String? // Additional notes

  paidAt    DateTime @default(now()) // When payment was made
  createdAt DateTime @default(now())

  @@index([businessId])
  @@index([businessId, supplierName])
  @@index([businessId, paidAt])
}

model Anomaly {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  businessId String   @db.ObjectId
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  type     String // "ZERO_PRICE_PRODUCT", "MISSING_IMAGE", "OUT_OF_STOCK", etc.
  severity String // "LOW", "MEDIUM", "HIGH", "CRITICAL"
  status   String @default("OPEN") // "OPEN", "RESOLVED", "IGNORED"

  // Details about the anomaly
  title       String
  description String

  // Reference to affected entity
  entityType String? // "PRODUCT", "ORDER", "CUSTOMER", etc.
  entityId   String? @db.ObjectId
  entityName String? // For display purposes
  entitySku  String? // Product SKU (if entity is a product)

  // Resolution tracking
  resolvedAt DateTime?
  resolvedBy String?   @db.ObjectId

  // Detection metadata
  detectedAt  DateTime @default(now())
  lastChecked DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId])
  @@index([businessId, status])
  @@index([businessId, type])
  @@index([detectedAt])
}

model BusinessUser {
  id         String       @id @default(auto()) @map("_id") @db.ObjectId
  userId     String       @db.ObjectId
  businessId String       @db.ObjectId
  role       BusinessRole @default(STAFF)

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, businessId])
}

model Category {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?

  // Multi-language fields
  nameAl        String? // Albanian name
  descriptionAl String? // Albanian description
  nameEl        String? // Greek name
  descriptionEl String? // Greek description

  // Subcategory support
  parentId String?    @db.ObjectId // Parent category ID (null = top-level)
  parent   Category?  @relation("CategoryChildren", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children Category[] @relation("CategoryChildren")

  // Configuration: Hide parent in storefront if only 1 parent (show only subcategories)
  hideParentInStorefront Boolean @default(false)

  image      String?
  sortOrder  Int     @default(0)
  isActive   Boolean @default(true)
  businessId String  @db.ObjectId

  // Marketplace/Multi-business support
  connectedBusinesses String[] @db.ObjectId

  metadata Json? // For storing external system data (e.g., external category IDs)

  business Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  products Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parentId])
  @@index([businessId, parentId])
}

model Product {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  name          String
  nameAl        String? // Albanian product name
  nameEl        String? // Greek product name
  description   String?
  descriptionAl String? // Albanian product description
  descriptionEl String? // Greek product description
  images        String[]
  price         Float
  originalPrice Float?
  costPrice     Float? // Cost price from supplier (for margin calculations)
  supplierName  String? // Name of the supplier
  sku           String?
  stock         Int      @default(0)
  reservedStock Int      @default(0) // Stock reserved for pending orders
  isActive      Boolean  @default(true)
  featured      Boolean  @default(false)

  trackInventory Boolean @default(true)
  lowStockAlert  Int?

  enableLowStockNotification Boolean @default(false)

  // Sale date fields
  saleStartDate DateTime? // When the sale price becomes active
  saleEndDate   DateTime? // When the sale price expires

  categoryId    String   @db.ObjectId
  businessId    String   @db.ObjectId
  brandId       String?  @db.ObjectId
  collectionIds String[] @db.ObjectId // Array of collection IDs (MongoDB-friendly)
  groupIds      String[] @db.ObjectId // Array of group IDs (MongoDB-friendly)

  // Marketplace/Multi-business support - businesses that can also sell this product
  connectedBusinesses String[] @db.ObjectId

  inventoryActivities InventoryActivity[]

  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  brand    Brand?   @relation(fields: [brandId], references: [id], onDelete: SetNull)

  variants   ProductVariant[]
  modifiers  ProductModifier[]
  orderItems OrderItem[]
  events     ProductEvent[]

  metaTitle       String?
  metaDescription String?
  metadata        Json? // For storing external system data (e.g., external product IDs)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Performance indexes for storefront queries
  @@index([brandId])
  @@index([businessId])
  @@index([businessId, isActive])
  @@index([businessId, isActive, price])
  @@index([categoryId])
  @@index([businessId, categoryId, isActive])
  @@index([businessId, isActive, featured])
  @@index([businessId, isActive, price, name])
}

model Brand {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  businessId  String  @db.ObjectId
  name        String
  nameAl      String? // Albanian name
  nameEl      String? // Greek name
  description String?
  logo        String?
  website     String?
  sortOrder   Int     @default(0)
  isActive    Boolean @default(true)

  // Marketplace/Multi-business support
  connectedBusinesses String[] @db.ObjectId

  metadata Json? // For storing external system data (e.g., external brand IDs)

  business Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  products Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId])
  @@index([businessId, isActive])
}

model Collection {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  businessId  String  @db.ObjectId
  name        String
  nameAl      String? // Albanian name
  nameEl      String? // Greek name
  description String?
  image       String?
  sortOrder   Int     @default(0)
  isActive    Boolean @default(true)
  featured    Boolean @default(false)

  // Marketplace/Multi-business support
  connectedBusinesses String[] @db.ObjectId

  metadata Json? // For storing external system data (e.g., external collection IDs)

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId])
  @@index([businessId, isActive])
  @@index([businessId, featured])
}

model Group {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  businessId  String  @db.ObjectId
  name        String
  nameAl      String? // Albanian name
  nameEl      String? // Greek name
  description String?
  sortOrder   Int     @default(0)
  isActive    Boolean @default(true)

  // Marketplace/Multi-business support
  connectedBusinesses String[] @db.ObjectId

  metadata Json? // For storing external system data (e.g., external group IDs)

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId])
  @@index([businessId, isActive])
}

model ProductVariant {
  id            String  @id @default(auto()) @map("_id") @db.ObjectId
  name          String
  price         Float
  originalPrice Float? // Regular price before sale
  stock         Int     @default(0)
  reservedStock Int     @default(0) // Stock reserved for pending orders
  sku           String?
  productId     String  @db.ObjectId
  metadata      Json? // For storing external system data (e.g., articleNo, attributes, images, sale dates)

  // Sale date fields
  saleStartDate DateTime? // When the sale price becomes active
  saleEndDate   DateTime? // When the sale price expires

  product    Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  orderItems OrderItem[]

  inventoryActivities InventoryActivity[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Performance indexes
  @@index([productId])
  @@index([productId, stock])
}

model InventoryActivity {
  id         String  @id @default(auto()) @map("_id") @db.ObjectId
  productId  String  @db.ObjectId
  variantId  String? @db.ObjectId
  businessId String  @db.ObjectId

  type     InventoryChangeType
  quantity Int
  oldStock Int
  newStock Int
  reason   String?

  changedBy String?

  product  Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant  ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)
  business Business        @relation(fields: [businessId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ContactMessage {
  id      String         @id @default(auto()) @map("_id") @db.ObjectId
  name    String
  email   String
  company String?
  useCase String?
  subject ContactSubject @default(GENERAL)
  message String

  isSpam    Boolean @default(false)
  spamScore Float?

  ipAddress String?
  userAgent String?
  referer   String?

  // Geolocation from IP
  country     String?
  city        String?
  region      String?
  countryCode String?

  status ContactStatus @default(PENDING)

  adminNotes  String?
  assignedTo  String?
  respondedAt DateTime?
  respondedBy String?

  emailSent      Boolean   @default(false)
  emailSentAt    DateTime?
  emailConfirmed Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
  @@map("contact_messages")
}

model ProductModifier {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  price     Float   @default(0)
  required  Boolean @default(false)
  productId String  @db.ObjectId

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Customer {
  id         String  @id @default(auto()) @map("_id") @db.ObjectId
  name       String
  phone      String
  email      String?
  address    String?
  businessId String  @db.ObjectId

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  orders   Order[]

  tier CustomerTier @default(REGULAR)

  addressJson Json?

  addedByAdmin Boolean  @default(false)
  tags         String[]
  notes        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([phone, businessId])
}

model DeliveryZone {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  maxDistance Float
  fee         Float
  isActive    Boolean @default(true)
  sortOrder   Int     @default(0)
  businessId  String  @db.ObjectId

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId])
}

model Postal {
  id             String  @id @default(auto()) @map("_id") @db.ObjectId
  businessId     String  @db.ObjectId
  name           String // e.g., "Posta Shqiptare"
  nameAl         String? // Albanian name
  nameEl         String? // Greek name
  type           String  @default("normal") // "normal" or "fast"
  description    String?
  descriptionAl  String?
  descriptionEl  String?
  deliveryTime   String? // e.g., "3-5 days"
  deliveryTimeAl String? // Albanian delivery time
  deliveryTimeEl String? // Greek delivery time
  logo           String? // Logo path
  isActive       Boolean @default(true)

  business Business        @relation(fields: [businessId], references: [id], onDelete: Cascade)
  pricing  PostalPricing[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([businessId, name])
  @@index([businessId, isActive])
}

model PostalPricing {
  id              String    @id @default(auto()) @map("_id") @db.ObjectId
  businessId      String    @db.ObjectId
  postalId        String    @db.ObjectId
  cityName        String // City name (e.g., "Tirana", "DurrÃ«s")
  type            String    @default("normal") // "normal" or "fast"
  price           Float
  priceWithoutTax Float?
  minOrderValue   Float? // Minimum order for this pricing
  maxOrderValue   Float? // Maximum order for this pricing
  deliveryTime    String? // Override postal default
  deliveryTimeAl  String? // Albanian override
  deliveryTimeEl  String? // Greek override
  notes           String?
  deletedAt       DateTime?

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  postal   Postal   @relation(fields: [postalId], references: [id], onDelete: Cascade)
  orders   Order[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([businessId, postalId, cityName, type])
  @@index([businessId, cityName])
  @@index([postalId])
}

model Order {
  id          String      @id @default(auto()) @map("_id") @db.ObjectId
  orderNumber String      @unique
  status      OrderStatus @default(PENDING)
  type        OrderType   @default(DELIVERY)

  customerId   String  @db.ObjectId
  businessId   String  @db.ObjectId
  customerName String? // Store customer name at order creation time (optional for backwards compatibility)

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  items         OrderItem[]
  notifications OrderNotification[]

  customerLatitude  Float?
  customerLongitude Float?

  subtotal    Float
  deliveryFee Float @default(0)
  tax         Float @default(0)
  discount    Float @default(0)
  total       Float

  deliveryAddress String?
  deliveryTime    DateTime?
  notes           String?

  // Postal service (for RETAIL businesses)
  postalPricingId String?        @db.ObjectId
  postalPricing   PostalPricing? @relation(fields: [postalPricingId], references: [id])

  createdByAdmin Boolean @default(false)
  createdBy      String? @db.ObjectId

  paymentStatus PaymentStatus @default(PENDING)
  paymentMethod String?

  whatsappMessageId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OrderItem {
  id            String @id @default(auto()) @map("_id") @db.ObjectId
  quantity      Int
  price         Float
  originalPrice Float? // Original price before discount (if applicable)

  orderId   String  @db.ObjectId
  productId String  @db.ObjectId
  variantId String? @db.ObjectId

  order   Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  modifiers String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TeamInvitation {
  id         String           @id @default(auto()) @map("_id") @db.ObjectId
  email      String
  businessId String           @db.ObjectId
  role       BusinessRole     @default(STAFF)
  token      String           @unique
  status     InvitationStatus @default(PENDING)
  expiresAt  DateTime

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Audit Log for tracking sensitive team actions
model TeamAuditLog {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  businessId String   @db.ObjectId
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  // Who performed the action
  actorId    String @db.ObjectId
  actorEmail String

  // Action details
  action      TeamAuditAction
  targetId    String? // ID of the affected user/invitation
  targetEmail String? // Email of the affected user

  // Additional context
  details   String? // JSON string with additional details
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([businessId])
  @@index([businessId, createdAt])
  @@index([actorId])
}

enum TeamAuditAction {
  MEMBER_INVITED
  MEMBER_ROLE_CHANGED
  MEMBER_REMOVED
  INVITATION_RESENT
  INVITATION_CANCELLED
  INVITATION_ACCEPTED
}

// Individual visitor sessions - stores each visit separately (no aggregation)
model VisitorSession {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  businessId String   @db.ObjectId
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  // UTM Parameters (from URL query params)
  source    String? // utm_source or parsed from referrer: "gazetareforma.com", "google", "direct"
  medium    String? // utm_medium: "referral", "cpc", "organic"
  campaign  String? // utm_campaign: "summer_sale", "newsletter"
  term      String? // utm_term: search keywords
  content   String? // utm_content: ad variation
  placement String? // Custom placement parameter

  // Referrer Information
  referrer     String? // HTTP referer header
  referrerHost String? // Parsed hostname from referrer

  // Geographic Data
  country   String? // Country name (e.g., "Greece", "Albania")
  city      String? // City name (e.g., "Athens", "Tirana")
  region    String? // State/Province/Region (e.g., "Attica", "Tirana County")
  latitude  Float? // Geographic latitude
  longitude Float? // Geographic longitude

  // Device Information
  deviceType String? // "mobile", "desktop", "tablet"
  browser    String? // "Chrome", "Safari", etc.
  os         String? // "iOS", "Android", "Windows"

  // Product Share Tracking
  productShareId String? @db.ObjectId // Product ID if visit came from a product share link

  // Technical Metadata
  ipAddress String? // Client IP (consider hashing for privacy)
  userAgent String? // User agent string

  // Timestamps
  visitedAt DateTime @default(now())
  createdAt DateTime @default(now())

  // Indexes for fast queries
  @@index([businessId])
  @@index([businessId, visitedAt])
  @@index([businessId, source])
  @@index([businessId, medium])
  @@index([businessId, campaign])
  @@index([visitedAt])
}

// Keep Analytics for backward compatibility and pre-aggregated daily stats
// NOTE: Removed unique constraint to allow multiple records per day
model Analytics {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  businessId String   @db.ObjectId
  date       DateTime

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  visitors Int   @default(0)
  orders   Int   @default(0)
  revenue  Float @default(0)

  // Geographic data (aggregated per day)
  country   String? // Country name (e.g., "Greece", "Albania")
  city      String? // City name (e.g., "Athens", "Tirana")
  region    String? // State/Province/Region (e.g., "Attica", "Tirana County")
  latitude  Float? // Geographic latitude
  longitude Float? // Geographic longitude
  ipAddress String? // IP address (for reference, can be hashed for privacy)

  // Device information (aggregated per day)
  deviceType String? // "mobile", "desktop", "tablet"
  browser    String? // "Chrome", "Safari", etc.
  os         String? // "iOS", "Android", "Windows"

  // UTM parameters (from query string)
  source    String? // UTM source (e.g., "google", "facebook")
  campaign  String? // UTM campaign (e.g., "summer_sale")
  medium    String? // UTM medium (e.g., "email", "cpc")
  term      String? // UTM term (e.g., "keyword")
  content   String? // UTM content (e.g., "ad_variant")
  placement String? // Custom placement parameter

  // Technical metadata
  referrer  String? // HTTP referrer
  userAgent String? // User agent string

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // REMOVED: @@unique([businessId, date]) - This was causing data loss!
  @@index([businessId, date])
  @@index([businessId, country])
  @@index([businessId, city])
  @@index([businessId, source])
  @@index([businessId, campaign])
}

// Product analytics events - tracks views and add-to-cart actions
model ProductEvent {
  id         String  @id @default(auto()) @map("_id") @db.ObjectId
  businessId String  @db.ObjectId
  productId  String  @db.ObjectId
  eventType  String // "view", "add_to_cart"
  sessionId  String? // Anonymous session ID (UUID from localStorage)

  // Context
  source String? // "product_card", "product_modal", "search", "featured"

  // Timestamps
  createdAt DateTime @default(now())

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Performance indexes for analytics queries
  @@index([businessId, productId])
  @@index([businessId, eventType])
  @@index([businessId, createdAt])
  @@index([productId, eventType])
  @@index([businessId, productId, eventType, createdAt])
}

enum UserRole {
  SUPER_ADMIN
  BUSINESS_OWNER
  STAFF
}

enum InventoryChangeType {
  MANUAL_INCREASE
  MANUAL_DECREASE
  ORDER_SALE
  RESTOCK
  ADJUSTMENT
  LOSS
  RETURN
}

enum BusinessRole {
  OWNER
  MANAGER
  STAFF
}

enum BusinessType {
  RESTAURANT
  CAFE
  RETAIL
  JEWELRY
  FLORIST
  GROCERY
  OTHER
}

enum SubscriptionPlan {
  STARTER
  PRO
  BUSINESS
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  CANCELLED
  EXPIRED
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  STRIPE
  PAYPAL
  BKT
  MOBILE_WALLET
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY
  PICKED_UP
  OUT_FOR_DELIVERY
  DELIVERED
  CANCELLED
  REFUNDED
}

enum OrderType {
  DELIVERY
  PICKUP
  DINE_IN
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum CustomerTier {
  REGULAR
  VIP
  WHOLESALE
}

enum BusinessGoal {
  ACCEPT_WHATSAPP_ORDERS
  MANAGE_PRODUCTS_INVENTORY
  TRACK_DELIVERY_PICKUP
  BUILD_CUSTOMER_RELATIONSHIPS
  TEAM_COLLABORATION
}

enum DomainStatus {
  NONE
  PENDING
  ACTIVE
  FAILED
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

enum ContactSubject {
  GENERAL
  DEMO
  SETUP
  BILLING
  TECHNICAL
  FEATURE
}

enum ContactStatus {
  PENDING
  IN_PROGRESS
  RESOLVED
  SPAM
  CLOSED
}

// Support Ticket Model
model SupportTicket {
  id           String         @id @default(auto()) @map("_id") @db.ObjectId
  ticketNumber String         @unique
  subject      String
  description  String
  status       TicketStatus   @default(OPEN)
  priority     TicketPriority @default(MEDIUM)
  type         TicketType     @default(GENERAL)

  // Relations
  businessId String   @db.ObjectId
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  createdById String @db.ObjectId
  createdBy   User   @relation("TicketCreator", fields: [createdById], references: [id])

  assignedToId String? @db.ObjectId
  assignedTo   User?   @relation("TicketAssignee", fields: [assignedToId], references: [id])

  // Comments
  comments TicketComment[]

  resolvedAt   DateTime?
  resolvedById String?   @db.ObjectId
  resolvedBy   User?     @relation("TicketResolver", fields: [resolvedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId])
  @@index([status])
  @@index([createdById])
}

model TicketComment {
  id         String  @id @default(auto()) @map("_id") @db.ObjectId
  content    String
  isInternal Boolean @default(false)

  ticketId String        @db.ObjectId
  ticket   SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  authorId String @db.ObjectId
  author   User   @relation(fields: [authorId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ticketId])
}

// Support Message Model (Thread-based messaging)
model SupportMessage {
  id       String  @id @default(auto()) @map("_id") @db.ObjectId
  threadId String
  subject  String?
  content  String

  businessId String?   @db.ObjectId
  business   Business? @relation(fields: [businessId], references: [id], onDelete: Cascade)

  senderId String @db.ObjectId
  sender   User   @relation("MessageSender", fields: [senderId], references: [id])

  recipientId String @db.ObjectId
  recipient   User   @relation("MessageRecipient", fields: [recipientId], references: [id])

  isRead Boolean   @default(false)
  readAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([threadId])
  @@index([senderId])
  @@index([recipientId])
  @@index([businessId])
}

// Notification Model
model Notification {
  id      String           @id @default(auto()) @map("_id") @db.ObjectId
  type    NotificationType
  title   String
  message String
  link    String?

  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  isRead Boolean   @default(false)
  readAt DateTime?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

// Enums
enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_RESPONSE
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketType {
  GENERAL
  TECHNICAL
  BILLING
  FEATURE_REQUEST
  BUG_REPORT
}

enum NotificationType {
  TICKET_CREATED
  TICKET_UPDATED
  TICKET_RESOLVED
  MESSAGE_RECEIVED
  SYSTEM_UPDATE
}

// SuperAdmin Settings Model
model SuperAdminSettings {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Email settings
  primaryEmail   String
  backupEmails   String[]
  emailFrequency EmailFrequency @default(IMMEDIATE)
  emailDigest    Boolean        @default(false)
  urgentOnly     Boolean        @default(false)

  // Support settings
  autoAssignTickets     Boolean        @default(false)
  defaultTicketPriority TicketPriority @default(MEDIUM)
  responseTimeSLA       Int            @default(24) // hours
  workingHours          WorkingHours?

  // Notification preferences
  emailNotificationsTicketCreated   Boolean @default(true)
  emailNotificationsTicketUpdated   Boolean @default(true)
  emailNotificationsTicketResolved  Boolean @default(true)
  emailNotificationsMessageReceived Boolean @default(true)

  businessNotificationsTicketCreated   Boolean @default(true)
  businessNotificationsTicketUpdated   Boolean @default(true)
  businessNotificationsTicketResolved  Boolean @default(true)
  businessNotificationsMessageReceived Boolean @default(true)

  // Support contact settings
  supportEmail     String @default("support@waveorder.app")
  supportPhone     String @default("+1 (555) 123-4567")
  supportWebsite   String @default("https://waveorder.app/support")
  supportHours     String @default("Monday - Friday, 9:00 AM - 6:00 PM EST")
  responseTime     String @default("Within 24 hours")
  emergencyContact String @default("emergency@waveorder.app")
  supportMessage   String @default("We're here to help! Contact us anytime for support with your WaveOrder store.")
  supportTeamName  String @default("WaveOrder Support Team")

  userId String @unique @db.ObjectId
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model WorkingHours {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  enabled   Boolean @default(false)
  startTime String  @default("09:00")
  endTime   String  @default("17:00")
  timezone  String  @default("UTC")

  settingsId String             @unique @db.ObjectId
  settings   SuperAdminSettings @relation(fields: [settingsId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum EmailFrequency {
  IMMEDIATE
  HOURLY
  DAILY
}

model Country {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  code      String @unique
  geonameId Int

  states State[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model State {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  code      String
  countryId String @db.ObjectId
  geonameId Int

  country Country @relation(fields: [countryId], references: [id], onDelete: Cascade)
  cities  City[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([countryId, code])
  @@index([countryId])
}

model City {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  stateId   String @db.ObjectId
  geonameId Int

  state State @relation(fields: [stateId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([stateId])
  @@index([stateId, name])
}

model ExternalSync {
  id                      String    @id @default(auto()) @map("_id") @db.ObjectId
  businessId              String    @db.ObjectId
  name                    String // Name/description of this sync configuration
  externalSystemName      String? // Name of the external system
  externalSystemBaseUrl   String? // Base URL for external product system API
  externalSystemApiKey    String? // API key for external system authentication
  externalSystemEndpoints Json? // Endpoint paths (e.g., { products: "/products", categories: "/categories" })
  externalBrandIds        Json? // External brand ID(s) - can be string or array of strings
  isActive                Boolean   @default(true)
  lastSyncAt              DateTime?
  lastSyncStatus          String? // 'success', 'failed', 'partial'
  lastSyncError           String?
  syncFrequency           String? // Optional: 'manual', 'hourly', 'daily', etc. (for future use)

  // Safeguards to prevent concurrent syncs
  isRunning     Boolean   @default(false) // True when sync is in progress
  syncStartedAt DateTime? // When current sync started (for stale lock detection)

  business Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)
  logs     ExternalSyncLog[] // History of all sync runs

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId])
  @@index([businessId, isActive])
}

// Sync log history - stores every sync run
model ExternalSyncLog {
  id         String @id @default(auto()) @map("_id") @db.ObjectId
  syncId     String @db.ObjectId
  businessId String @db.ObjectId

  // Sync details
  status         String // 'success', 'failed', 'partial', 'running'
  error          String? // Error message if failed
  processedCount Int     @default(0) // Number of products processed
  skippedCount   Int     @default(0) // Number of products skipped
  errorCount     Int     @default(0) // Number of products with errors

  // Pagination info
  currentPage  Int? // Current page synced
  totalPages   Int? // Total pages available
  perPage      Int? // Products per page
  syncAllPages Boolean @default(false) // Whether all pages were synced

  // Timing
  startedAt   DateTime  @default(now())
  completedAt DateTime? // Null if still running or crashed

  // Duration in milliseconds (calculated)
  duration Int? // completedAt - startedAt in ms

  // Additional metadata
  metadata Json? // Store additional info (errors array, etc.)

  sync     ExternalSync @relation(fields: [syncId], references: [id], onDelete: Cascade)
  business Business     @relation(fields: [businessId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([syncId])
  @@index([businessId])
  @@index([businessId, startedAt])
  @@index([syncId, startedAt])
}

// Team Member management for SuperAdmin
model TeamMember {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Profile Information
  name   String
  email  String  @unique
  phone  String?
  avatar String? // Profile picture URL
  title  String? // Job title (e.g., "Senior Account Manager")

  // Role and Department
  role       TeamRole
  department TeamDepartment?

  // Optional User Connection (for system access)
  userId String? @db.ObjectId
  user   User?   @relation(fields: [userId], references: [id])

  // Team Member Location (where they are based)
  country  String? // Country (e.g., "United States", "Albania")
  city     String? // City (e.g., "New York", "Tirana")
  timezone String? // Timezone (e.g., "America/New_York", "Europe/Tirane")

  // Territory & Region (sales coverage)
  territory String? // Geographic territory (e.g., "North America", "Europe")
  region    String? // Specific region (e.g., "Northeast US", "UK")
  countries String[] // Countries they handle

  // Targets & Goals
  monthlyLeadQuota     Int? // Target leads per month
  monthlyRevenueTarget Float? // Revenue target per month
  quarterlyTarget      Float? // Quarterly revenue target

  // Performance Metrics (can be calculated or manually updated)
  totalLeadsAssigned  Int   @default(0)
  totalLeadsConverted Int   @default(0)
  totalRevenue        Float @default(0)
  conversionRate      Float @default(0)

  // Status
  isActive  Boolean   @default(true)
  startDate DateTime? // When they joined

  // Bio & Notes
  bio    String?
  skills String[]
  notes  String?

  // Relations
  assignedLeads      Lead[]     @relation("TeamMemberLeads")
  assignedBusinesses Business[] @relation("AccountManagerBusinesses")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([role])
  @@index([department])
  @@index([isActive])
  @@index([territory])
}

enum TeamRole {
  // Sales & Revenue
  SALES_REPRESENTATIVE
  ACCOUNT_EXECUTIVE
  ACCOUNT_MANAGER
  SALES_MANAGER

  // Marketing
  MARKETING_MANAGER
  CONTENT_SPECIALIST
  GROWTH_MANAGER

  // Customer Success
  CUSTOMER_SUCCESS_MANAGER
  SUPPORT_SPECIALIST
  ONBOARDING_SPECIALIST

  // Technology
  DEVELOPER
  TECHNICAL_SUPPORT
  PRODUCT_MANAGER

  // Executive
  CEO
  CTO
  COO
  CFO
  VP_SALES
  VP_MARKETING
  VP_ENGINEERING
  VP_CUSTOMER_SUCCESS

  // Operations
  OPERATIONS_MANAGER
  PROJECT_MANAGER

  // Other
  INTERN
  CONTRACTOR
  OTHER
}

enum TeamDepartment {
  SALES
  MARKETING
  CUSTOMER_SUCCESS
  ENGINEERING
  PRODUCT
  OPERATIONS
  EXECUTIVE
  FINANCE
  HR
  OTHER
}

// Lead/Prospect management for SuperAdmin
model Lead {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Contact Information
  name    String
  email   String?
  phone   String?
  company String? // Company/Business name
  country String? // Country code or name

  // Lead Source & Tracking
  source       LeadSource @default(WEBSITE)
  sourceDetail String? // Additional source info (e.g., "Contact Form", "Demo Request")
  referredBy   String? // Who referred them

  // Status & Priority
  status   LeadStatus   @default(NEW)
  priority LeadPriority @default(MEDIUM)
  score    Int          @default(0) // Lead score (0-100)

  // Assignment (supports both User and TeamMember)
  assignedToId String?   @db.ObjectId
  assignedTo   User?     @relation("LeadAssignee", fields: [assignedToId], references: [id])
  assignedAt   DateTime?

  // Team Member Assignment (preferred over User assignment)
  teamMemberId String?     @db.ObjectId
  teamMember   TeamMember? @relation("TeamMemberLeads", fields: [teamMemberId], references: [id])

  // Business Interest
  businessType   String? // What type of business they want (restaurant, retail, etc.)
  estimatedValue Float? // Estimated potential value
  expectedPlan   String? // Expected subscription plan (STARTER, PRO, BUSINESS)

  // Communication
  lastContactedAt DateTime?
  nextFollowUpAt  DateTime?
  contactCount    Int       @default(0)

  // Conversion Tracking
  convertedAt     DateTime?
  convertedToId   String?   @db.ObjectId // Business ID if converted
  conversionNotes String?

  // Notes & Activities
  notes String?
  tags  String[]

  // Metadata
  ipAddress   String?
  userAgent   String?
  landingPage String? // Which page they came from

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Activities/interactions log
  activities LeadActivity[]

  @@index([status])
  @@index([assignedToId])
  @@index([source])
  @@index([priority])
  @@index([createdAt])
  @@index([status, assignedToId])
  @@index([nextFollowUpAt])
}

// Lead Activity/Interaction Log
model LeadActivity {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  leadId String @db.ObjectId
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)

  type        LeadActivityType
  title       String
  description String?

  // Who performed the activity
  performedById String? @db.ObjectId
  performedBy   String? // Name of who did it (in case user is deleted)

  // Additional data
  metadata Json?

  createdAt DateTime @default(now())

  @@index([leadId])
  @@index([leadId, createdAt])
}

enum LeadSource {
  WEBSITE // Website contact form
  DEMO_REQUEST // Demo request
  REFERRAL // Referred by existing customer
  SOCIAL // Social media (Instagram, Facebook, etc.)
  EMAIL // Email outreach
  PHONE // Phone inquiry
  PARTNER // Partner referral
  EVENT // Trade show/event
  ADVERTISING // Paid advertising
  ORGANIC // Organic search
  OTHER // Other sources
}

enum LeadStatus {
  NEW // Just created, not yet contacted
  CONTACTED // Initial contact made
  QUALIFIED // Qualified as potential customer
  DEMO_SCHEDULED // Demo scheduled
  NEGOTIATING // In negotiation/pricing discussion
  WON // Converted to customer
  LOST // Did not convert
  NURTURING // Long-term nurture (not ready now)
}

enum LeadPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum LeadActivityType {
  NOTE // General note
  EMAIL_SENT // Email sent to lead
  EMAIL_RECEIVED // Email received from lead
  CALL // Phone call
  MEETING // Meeting (virtual or in-person)
  DEMO // Demo given
  FOLLOW_UP // Follow-up scheduled
  STATUS_CHANGE // Status changed
  ASSIGNED // Lead assigned to someone
  CREATED // Lead created
}

// Business Feedback - tracks feedback from businesses
model BusinessFeedback {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  businessId String   @db.ObjectId
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  type   FeedbackType   @default(INITIAL) // Type of feedback (initial, periodic, nps, etc.)
  source FeedbackSource // How feedback was collected

  rating   Int // 1-5 star rating
  feedback String? // Open text feedback

  // Who submitted the feedback
  submittedById    String? @db.ObjectId // User ID (null if submitted by superadmin on behalf)
  submittedByEmail String? // Email of submitter (for reference)
  submittedByName  String? // Name of submitter

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId])
  @@index([businessId, type])
  @@index([type])
  @@index([source])
  @@index([createdAt])
}

enum FeedbackType {
  INITIAL // Initial feedback after onboarding
  PERIODIC // Periodic check-in feedback
  NPS // Net Promoter Score
  FEATURE_REQUEST // Feature request feedback
  SUPPORT // Support-related feedback
  OTHER // Other feedback
}

enum FeedbackSource {
  ADMIN_FORM // Business submitted via admin floating form
  SUPERADMIN_MANUAL // SuperAdmin added manually
  EMAIL // Collected via email
  PHONE // Collected via phone call
  OTHER // Other source
}

// System logs for tracking errors, 404s, and system events
model SystemLog {
  id       String @id @default(auto()) @map("_id") @db.ObjectId
  logType  String // 'storefront_404', 'storefront_error', 'products_error', 'system_error'
  severity String // 'error', 'warning', 'info'

  // Request context
  slug       String? // Storefront slug (if applicable)
  businessId String?   @db.ObjectId // Business ID (if applicable)
  business   Business? @relation(fields: [businessId], references: [id], onDelete: SetNull)
  endpoint   String // API endpoint or route
  method     String // HTTP method
  statusCode Int? // HTTP status code

  // Error details
  errorMessage String? // Error message
  errorStack   String? // Error stack trace (if available)

  // Request metadata
  ipAddress String? // Client IP address
  userAgent String? // User agent
  referrer  String? // Referrer URL
  url       String // Full request URL

  // Location data (parsed from IP)
  country String?
  city    String?
  region  String?

  // Additional context
  metadata Json? // Additional context data

  createdAt DateTime @default(now())

  @@index([logType])
  @@index([severity])
  @@index([slug])
  @@index([businessId])
  @@index([statusCode])
  @@index([createdAt])
  @@index([logType, createdAt])
  @@index([businessId, createdAt])
}

// API Keys for Business Plan API Access
model ApiKey {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  businessId String   @db.ObjectId
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  name       String // User-friendly name: "Mobile App", "POS Integration", etc.
  keyHash    String // SHA-256 hash of the API key (never store plain key)
  keyPreview String // Last 4 characters for display: "...abc1"

  // Scopes/permissions for granular access control
  scopes String[] @default(["products:read", "orders:read", "categories:read"])

  // Usage tracking
  lastUsedAt   DateTime?
  requestCount Int       @default(0) // Total requests made with this key

  // Key lifecycle
  expiresAt DateTime? // Optional expiry date
  isActive  Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId])
  @@index([keyHash])
  @@index([isActive])
}
